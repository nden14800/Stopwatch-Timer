<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel 10 Clock - Bootstrap Edition</title>
    
    <!-- Fonts: Outfit (Geometry compatible) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* --- Pixel Theme Variables --- */
        :root {
            --md-sys-color-background: #fdfcff;
            --md-sys-color-on-background: #1a1c1e;
            --md-sys-color-surface: #fdfcff;
            --md-sys-color-surface-container: #f0f4f8;
            --md-sys-color-surface-variant: #e1e2ec;
            
            --md-sys-color-primary: #006492;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #cae6ff;
            --md-sys-color-on-primary-container: #001e30;

            --md-sys-color-secondary-container: #dce2f9;
            --md-sys-color-on-secondary-container: #151b2c;
            
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            
            --md-sys-color-outline: #74777f;

            --shape-corner-medium: 16px;
            --shape-corner-large: 28px;
            --shape-corner-xl: 40px;
            
            --font-family: 'Outfit', sans-serif;
            
            --anim-standard: 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --md-sys-color-background: #000000;
                --md-sys-color-on-background: #e2e2e6;
                --md-sys-color-surface: #1a1c1e;
                --md-sys-color-surface-container: #1e222b;
                --md-sys-color-surface-variant: #44474f;
                
                --md-sys-color-primary: #8cceea;
                --md-sys-color-on-primary: #00344e;
                --md-sys-color-primary-container: #004b6f;
                --md-sys-color-on-primary-container: #cae6ff;

                --md-sys-color-secondary-container: #3e4856;
                --md-sys-color-on-secondary-container: #dce2f9;
                
                --md-sys-color-error: #ffb4ab;
                --md-sys-color-error-container: #93000a;
                --md-sys-color-on-error-container: #ffdad6;
                
                --md-sys-color-outline: #8e9099;
            }
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: background-color 0.4s, color 0.4s;
        }

        /* --- Animations --- */
        @keyframes ripple {
            0% { transform: scale(0); opacity: 0.5; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseAlert {
            0% { background-color: var(--md-sys-color-error-container); }
            50% { background-color: var(--md-sys-color-error); }
            100% { background-color: var(--md-sys-color-error-container); }
        }

        /* --- Layout --- */
        main {
            flex: 1; position: relative; overflow: hidden;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            transform: scale(0.95);
            background-color: var(--md-sys-color-background);
            z-index: 1;
        }
        .screen.active {
            opacity: 1; pointer-events: auto; transform: scale(1); z-index: 5;
        }

        /* Header */
        .header {
            width: 100%; padding: 16px 24px; display: flex; justify-content: flex-end; align-items: center; height: 64px;
        }
        .icon-btn {
            background: none; border: none; color: var(--md-sys-color-on-background);
            cursor: pointer; padding: 12px; border-radius: 50%;
            transition: background-color 0.2s;
            font-size: 24px; /* Bootstrap Icons default size fix */
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:active { background-color: var(--md-sys-color-surface-variant); }

        /* Typography */
        .display-large {
            font-size: 80px; font-weight: 200; line-height: 1; letter-spacing: -2px;
            font-variant-numeric: tabular-nums; margin: 20px 0;
            color: var(--md-sys-color-on-background);
        }

        /* --- Buttons with Ripple --- */
        .controls-wrapper {
            width: 100%; padding: 32px 24px;
            display: flex; justify-content: space-between; align-items: center;
            margin-top: auto;
        }
        
        .btn {
            border: none; outline: none; cursor: pointer;
            font-family: var(--font-family); font-weight: 500; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
            transition: transform 0.1s, background-color 0.3s, opacity 0.3s;
        }
        .btn::after {
            content: ""; position: absolute; background: rgba(255,255,255,0.3);
            border-radius: 50%; width: 100%; padding-top: 100%;
            top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            opacity: 0; pointer-events: none;
        }
        .btn:active::after {
            animation: ripple 0.6s ease-out;
        }
        .btn:active { transform: scale(0.96); }

        .btn-play {
            width: 110px; height: 72px; border-radius: 36px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            font-size: 32px; /* For icon */
        }
        .btn-secondary {
            width: 72px; height: 72px; border-radius: 50%;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-background);
            font-size: 24px;
        }
        .btn-fab {
            position: absolute; bottom: 30px; right: 24px;
            width: 64px; height: 64px; border-radius: 22px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 28px;
        }
        .btn-fab:active { transform: scale(0.95); }

        /* --- Navigation --- */
        .nav-bar {
            background-color: var(--md-sys-color-surface-container);
            height: 80px; display: flex; justify-content: space-around; align-items: center;
            z-index: 20; padding-bottom: 12px;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            border: none; background: transparent;
            color: var(--md-sys-color-on-background);
            font-family: var(--font-family); font-size: 12px; font-weight: 500;
            gap: 6px; opacity: 0.5; transition: opacity 0.2s; cursor: pointer;
        }
        .nav-icon-container {
            width: 64px; height: 32px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
            font-size: 20px;
        }
        .nav-item.active { opacity: 1; }
        .nav-item.active .nav-icon-container {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        /* --- STOPWATCH --- */
        .lap-list {
            flex: 1; width: 92%; overflow-y: auto;
            display: flex; flex-direction: column; gap: 8px; padding-bottom: 24px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .lap-list::-webkit-scrollbar { display: none; }
        
        .lap-card {
            background-color: var(--md-sys-color-surface-container);
            padding: 16px 24px; border-radius: 12px;
            display: flex; justify-content: space-between;
            font-size: 18px; font-variant-numeric: tabular-nums;
            animation: slideInUp 0.3s cubic-bezier(0.2, 0, 0, 1) forwards;
        }

        /* --- TIMER --- */
        .timer-list-container {
            flex: 1; width: 100%; overflow-y: auto;
            padding: 10px 16px 100px 16px;
            display: flex; flex-direction: column; gap: 16px; align-items: center;
        }
        
        .timer-card {
            width: 100%; max-width: 380px;
            background-color: var(--md-sys-color-surface-container);
            border-radius: 28px; padding: 24px 20px;
            position: relative;
            display: flex; flex-direction: column; align-items: center;
            transition: background-color 0.3s;
            animation: slideInUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards;
        }
        .timer-card.finished {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            animation: pulseAlert 1.2s infinite;
        }
        .timer-card.finished .circle-progress {
            stroke: var(--md-sys-color-error);
        }
        .timer-card.finished .circle-bg {
            stroke: rgba(0,0,0,0.1);
        }

        /* Circular Progress */
        .card-circle-container {
            width: 200px; height: 200px; position: relative;
        }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle {
            fill: none; stroke-width: 10; stroke-linecap: round;
        }
        .circle-bg { stroke: var(--md-sys-color-surface-variant); }
        .circle-progress {
            stroke: var(--md-sys-color-primary);
            stroke-dasharray: 565; /* 2*PI*90 */
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.1s linear;
        }
        
        .timer-card-time {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .time-text { font-size: 44px; font-weight: 300; line-height: 1; letter-spacing: -1px; }
        .end-text { font-size: 13px; opacity: 0.7; margin-top: 8px; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        
        .timer-card-controls {
            display: flex; gap: 20px; margin-top: 20px; width: 100%; justify-content: center;
        }
        .mini-btn {
            width: 48px; height: 48px; border-radius: 24px;
            border: none; background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-background);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
            font-size: 20px;
        }
        .mini-btn:active { transform: scale(0.92); }
        
        /* Input Mode */
        .timer-input-screen {
            background-color: var(--md-sys-color-background); z-index: 50;
        }
        .input-display-area {
            display: flex; flex-direction: column; align-items: center;
            margin-top: 40px; margin-bottom: 20px; cursor: pointer;
            padding: 20px; border-radius: 16px;
            transition: background-color 0.2s;
        }
        .input-display-area:active { background-color: var(--md-sys-color-surface-container); }
        
        .timer-val-display {
            font-size: 64px; font-weight: 300; color: var(--md-sys-color-primary);
            font-variant-numeric: tabular-nums;
        }
        .timer-val-display.placeholder { color: var(--md-sys-color-surface-variant); }
        
        .numpad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            width: 100%; max-width: 320px; padding: 0 10px;
        }
        .num-btn {
            height: 64px; border-radius: 32px; background: transparent;
            color: var(--md-sys-color-on-background); font-size: 26px;
            border: none; cursor: pointer; font-family: var(--font-family);
        }
        .num-btn:active { background-color: var(--md-sys-color-surface-variant); }
        
        /* Hidden Input for Keyboard */
        #hidden-input { position: absolute; opacity: 0; top: -1000px; }

        /* --- Settings Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; justify-content: center; align-items: flex-end;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .settings-sheet {
            width: 100%; max-width: 600px;
            background: var(--md-sys-color-surface);
            border-radius: 28px 28px 0 0; padding: 24px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        .modal-overlay.open .settings-sheet { transform: translateY(0); }
        
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid var(--md-sys-color-surface-container);
        }
        .setting-label { font-size: 16px; font-weight: 500; }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 32px; transition: .3s;
            border: 2px solid var(--md-sys-color-outline); box-sizing: border-box;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px; left: 6px; bottom: 6px;
            background-color: var(--md-sys-color-outline);
            border-radius: 50%; transition: .3s;
        }
        input:checked + .slider {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }
        input:checked + .slider:before {
            background-color: var(--md-sys-color-on-primary);
            transform: translateX(20px);
            height: 24px; width: 24px; left: 2px; bottom: 2px;
        }
    </style>
</head>
<body>

    <main>
        <!-- STOPWATCH SCREEN -->
        <div id="stopwatch-screen" class="screen active">
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; width:100%;">
                <div class="display-large" id="sw-display" style="margin-top:60px;">
                    00<span style="font-size:0.5em; vertical-align: top;">s</span>00
                </div>
                <div class="lap-list" id="sw-laps"></div>
            </div>

            <div class="controls-wrapper">
                <button class="btn btn-secondary" id="sw-btn-reset" onclick="resetStopwatch()" style="opacity: 0; pointer-events: none;">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button class="btn btn-play" id="sw-btn-main" onclick="toggleStopwatch()">
                    <i class="bi bi-play-fill" id="sw-icon-main"></i>
                </button>
                <button class="btn btn-secondary" id="sw-btn-lap" onclick="lapStopwatch()" style="opacity: 0; pointer-events: none;">
                    <i class="bi bi-flag-fill"></i>
                </button>
            </div>
        </div>

        <!-- TIMER LIST SCREEN -->
        <div id="timer-list-screen" class="screen">
            <div class="header">
                <button class="icon-btn" onclick="openSettings()">
                    <i class="bi bi-gear-fill"></i>
                </button>
            </div>

            <div class="timer-list-container" id="timers-container">
                <div id="no-timer-msg" style="margin-top:100px; color:var(--md-sys-color-outline);">
                    タイマーを追加してください
                </div>
            </div>

            <button class="btn btn-fab" onclick="showTimerInput()">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <!-- TIMER INPUT OVERLAY -->
        <div id="timer-input-screen" class="screen timer-input-screen">
            <div class="header">
                <button class="icon-btn" onclick="hideTimerInput()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="input-display-area" onclick="focusHiddenInput()">
                <div class="timer-val-display placeholder" id="timer-input-display">00h 00m 00s</div>
                <input type="tel" id="hidden-input" pattern="[0-9]*" inputmode="numeric">
            </div>

            <div class="numpad">
                <button class="num-btn" onclick="numpadInput(1)">1</button>
                <button class="num-btn" onclick="numpadInput(2)">2</button>
                <button class="num-btn" onclick="numpadInput(3)">3</button>
                <button class="num-btn" onclick="numpadInput(4)">4</button>
                <button class="num-btn" onclick="numpadInput(5)">5</button>
                <button class="num-btn" onclick="numpadInput(6)">6</button>
                <button class="num-btn" onclick="numpadInput(7)">7</button>
                <button class="num-btn" onclick="numpadInput(8)">8</button>
                <button class="num-btn" onclick="numpadInput(9)">9</button>
                <button class="num-btn" style="visibility:hidden"></button>
                <button class="num-btn" onclick="numpadInput(0)">0</button>
                <button class="num-btn" onclick="numpadDelete()"><i class="bi bi-backspace-fill"></i></button>
            </div>
            
            <div class="controls-wrapper" style="justify-content: center;">
                <button class="btn btn-play" id="tm-btn-create" onclick="createTimerFromInput()" style="opacity: 0.5; pointer-events: none;">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- NAVIGATION -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="navTo('stopwatch', this)">
            <div class="nav-icon-container">
                <i class="bi bi-stopwatch"></i>
            </div>
            <span>ストップウォッチ</span>
        </button>
        <button class="nav-item" onclick="navTo('timer-list', this)">
            <div class="nav-icon-container">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <span>タイマー</span>
        </button>
    </nav>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal" onclick="closeSettings(event)">
        <div class="settings-sheet" onclick="event.stopPropagation()">
            <h2 style="margin-top:0; margin-bottom:20px; font-weight:400; font-size:22px;">設定</h2>
            
            <div class="setting-item">
                <div class="setting-label">終了時の音 (警告音)</div>
                <label class="switch">
                    <input type="checkbox" id="setting-sound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">終了時刻に日付・年を表示</div>
                <label class="switch">
                    <input type="checkbox" id="setting-date">
                    <span class="slider"></span>
                </label>
            </div>

            <div style="margin-top:30px; text-align:right;">
                <button class="btn" style="display:inline-flex; background:var(--md-sys-color-secondary-container); color:var(--md-sys-color-on-secondary-container); padding:10px 24px; border-radius:20px;" onclick="closeSettingsForce()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // === GLOBAL APP STATE ===
        const appState = {
            settings: { sound: true, showDate: false },
            timers: [] 
        };

        // === AUDIO SYSTEM (ENHANCED ALARM) ===
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playAlarm() {
            if (!appState.settings.sound) return;
            initAudio();

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            // "Digital Alarm" Sound: Square wave, high pitch, pulsing
            osc.type = 'square';
            osc.frequency.setValueAtTime(880, t); // A5
            osc.frequency.setValueAtTime(1760, t + 0.1); // A6 (Pi-Pi)
            osc.frequency.setValueAtTime(880, t + 0.2); 
            osc.frequency.setValueAtTime(1760, t + 0.3);

            // Pulse Envelope
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.setValueAtTime(0.1, t + 0.08);
            gain.gain.setValueAtTime(0, t + 0.09); // Silence
            
            gain.gain.setValueAtTime(0.1, t + 0.1);
            gain.gain.setValueAtTime(0.1, t + 0.18);
            gain.gain.setValueAtTime(0, t + 0.19);

            gain.gain.setValueAtTime(0.1, t + 0.2);
            gain.gain.setValueAtTime(0.1, t + 0.28);
            gain.gain.setValueAtTime(0, t + 0.29);
            
            osc.start(t);
            osc.stop(t + 0.4);
        }

        // === NAVIGATION ===
        function navTo(screenId, btnEl) {
            document.querySelectorAll('.screen').forEach(el => {
                // Keep input screen managed separately
                if(el.id !== 'timer-input-screen') el.classList.remove('active');
            });
            document.getElementById(screenId + '-screen').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btnEl.classList.add('active');
        }

        // === STOPWATCH LOGIC ===
        // Totally isolated variables
        let swRunning = false;
        let swStartTime = 0;
        let swElapsed = 0;
        let swReqId = null;

        const swDisplay = document.getElementById('sw-display');
        const swBtnMain = document.getElementById('sw-btn-main');
        const swIconMain = document.getElementById('sw-icon-main');
        const swBtnReset = document.getElementById('sw-btn-reset');
        const swBtnLap = document.getElementById('sw-btn-lap');
        const swLaps = document.getElementById('sw-laps');

        function formatSwTime(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            const cs = Math.floor((ms % 1000) / 10);
            return `${m > 0 ? m + ':' : ''}${String(s).padStart(2,'0')}<span style="font-size:0.5em; vertical-align: top;">.</span>${String(cs).padStart(2,'0')}`;
        }

        function toggleStopwatch() {
            if (!swRunning) {
                // Start
                swRunning = true;
                swStartTime = Date.now() - swElapsed;
                swReqId = requestAnimationFrame(updateSwLoop);
                
                swIconMain.className = 'bi bi-pause-fill';
                swBtnMain.style.backgroundColor = 'var(--md-sys-color-primary-container)';
                swBtnMain.style.color = 'var(--md-sys-color-on-primary-container)';
                
                swBtnReset.style.opacity = 1; swBtnReset.style.pointerEvents = 'auto';
                swBtnLap.style.opacity = 1; swBtnLap.style.pointerEvents = 'auto';
            } else {
                // Stop
                swRunning = false;
                cancelAnimationFrame(swReqId);
                
                swIconMain.className = 'bi bi-play-fill';
                swBtnMain.style.backgroundColor = 'var(--md-sys-color-primary)';
                swBtnMain.style.color = 'var(--md-sys-color-on-primary)';
            }
        }

        function updateSwLoop() {
            if (!swRunning) return;
            swElapsed = Date.now() - swStartTime;
            swDisplay.innerHTML = formatSwTime(swElapsed);
            swReqId = requestAnimationFrame(updateSwLoop);
        }

        function resetStopwatch() {
            swRunning = false;
            cancelAnimationFrame(swReqId);
            swElapsed = 0;
            swDisplay.innerHTML = `00<span style="font-size:0.5em; vertical-align: top;">s</span>00`;
            swLaps.innerHTML = '';
            
            swIconMain.className = 'bi bi-play-fill';
            swBtnMain.style.backgroundColor = 'var(--md-sys-color-primary)';
            swBtnMain.style.color = 'var(--md-sys-color-on-primary)';
            
            swBtnReset.style.opacity = 0; swBtnReset.style.pointerEvents = 'none';
            swBtnLap.style.opacity = 0; swBtnLap.style.pointerEvents = 'none';
        }

        function lapStopwatch() {
            const lapCount = swLaps.children.length + 1;
            const div = document.createElement('div');
            div.className = 'lap-card';
            div.innerHTML = `<span>#${lapCount}</span> <span>${swDisplay.innerText}</span>`;
            swLaps.prepend(div);
        }

        // === TIMER INPUT LOGIC ===
        let tmRawInput = "";
        const tmInputScreen = document.getElementById('timer-input-screen');
        const tmInputDisplay = document.getElementById('timer-input-display');
        const tmBtnCreate = document.getElementById('tm-btn-create');
        const hiddenInput = document.getElementById('hidden-input');

        function showTimerInput() {
            tmInputScreen.classList.add('active');
            resetInput();
        }
        function hideTimerInput() {
            tmInputScreen.classList.remove('active');
        }
        function resetInput() {
            tmRawInput = "";
            hiddenInput.value = "";
            updateInputDisplay();
        }
        function updateInputDisplay() {
            let s = tmRawInput.padStart(6, '0');
            let h = parseInt(s.substring(0,2));
            let m = parseInt(s.substring(2,4));
            let sec = parseInt(s.substring(4,6));
            tmInputDisplay.textContent = `${h}h ${m}m ${sec}s`;
            if (tmRawInput.length > 0) {
                tmInputDisplay.classList.remove('placeholder');
                tmInputDisplay.style.color = 'var(--md-sys-color-on-background)';
                tmBtnCreate.style.opacity = 1; tmBtnCreate.style.pointerEvents = 'auto';
            } else {
                tmInputDisplay.classList.add('placeholder');
                tmBtnCreate.style.opacity = 0.5; tmBtnCreate.style.pointerEvents = 'none';
            }
        }
        function numpadInput(n) {
            if (tmRawInput.length < 6) { tmRawInput += n; updateInputDisplay(); }
        }
        function numpadDelete() {
            tmRawInput = tmRawInput.slice(0, -1); updateInputDisplay();
        }
        // Keyboard support
        function focusHiddenInput() { hiddenInput.focus(); }
        hiddenInput.addEventListener('input', (e) => {
            const nums = e.target.value.replace(/[^0-9]/g, '');
            tmRawInput = nums.slice(0, 6);
            e.target.value = tmRawInput;
            updateInputDisplay();
        });

        function createTimerFromInput() {
            let s = tmRawInput.padStart(6, '0');
            let totalMs = (parseInt(s.substring(0,2)) * 3600 + parseInt(s.substring(2,4)) * 60 + parseInt(s.substring(4,6))) * 1000;
            if (totalMs > 0) {
                addTimer(totalMs);
                hideTimerInput();
            }
        }

        // === TIMER SYSTEM LOGIC ===
        const timersContainer = document.getElementById('timers-container');
        const noTimerMsg = document.getElementById('no-timer-msg');

        function addTimer(durationMs) {
            const id = Date.now() + Math.random(); // Unique ID
            const timer = {
                id: id,
                totalMs: durationMs,
                remainingMs: durationMs,
                endTime: Date.now() + durationMs,
                running: true,
                finished: false,
                alarmInterval: null
            };
            appState.timers.push(timer);
            renderTimerCard(timer);
            checkNoTimers();
            // Start the global loop if this is the first timer
            if (appState.timers.length === 1) requestAnimationFrame(globalTimerLoop);
        }

        function checkNoTimers() {
            noTimerMsg.style.display = appState.timers.length === 0 ? 'block' : 'none';
        }

        function renderTimerCard(timer) {
            const div = document.createElement('div');
            div.className = 'timer-card';
            div.id = `timer-card-${timer.id}`;
            div.innerHTML = `
                <div class="card-circle-container">
                    <svg>
                        <circle cx="100" cy="100" r="90" class="circle-bg"></circle>
                        <circle cx="100" cy="100" r="90" class="circle-progress" id="progress-${timer.id}"></circle>
                    </svg>
                    <div class="timer-card-time">
                        <div class="time-text" id="time-text-${timer.id}">00:00</div>
                        <div class="end-text">
                            <i class="bi bi-bell-fill"></i>
                            <span id="end-time-${timer.id}">--:--</span>
                        </div>
                    </div>
                </div>
                <div class="timer-card-controls">
                    <button class="mini-btn" onclick="deleteTimer(${timer.id})">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                    <button class="mini-btn" onclick="toggleTimerState(${timer.id})" id="play-btn-${timer.id}">
                        <i class="bi bi-pause-fill" id="control-icon-${timer.id}"></i>
                    </button>
                    <button class="mini-btn" onclick="addMinuteToTimer(${timer.id})">
                        <i class="bi bi-plus-lg"></i> 1m
                    </button>
                </div>
            `;
            timersContainer.prepend(div);
            updateTimerUI(timer);
        }

        function deleteTimer(id) {
            const idx = appState.timers.findIndex(t => t.id === id);
            if (idx > -1) {
                // Clear alarm interval if exists
                if (appState.timers[idx].alarmInterval) clearInterval(appState.timers[idx].alarmInterval);
                appState.timers.splice(idx, 1);
                const el = document.getElementById(`timer-card-${id}`);
                if (el) el.remove();
            }
            checkNoTimers();
        }

        function toggleTimerState(id) {
            const timer = appState.timers.find(t => t.id === id);
            if (!timer) return;

            // If timer is finished, clicking the button stops/deletes it
            if (timer.finished) {
                deleteTimer(id);
                return;
            }

            const icon = document.getElementById(`control-icon-${id}`);
            if (timer.running) {
                timer.running = false;
                icon.className = 'bi bi-play-fill';
            } else {
                timer.running = true;
                timer.endTime = Date.now() + timer.remainingMs;
                icon.className = 'bi bi-pause-fill';
            }
            updateTimerUI(timer);
        }

        function addMinuteToTimer(id) {
            const timer = appState.timers.find(t => t.id === id);
            if (timer && !timer.finished) {
                timer.totalMs += 60000;
                timer.remainingMs += 60000;
                if (timer.running) timer.endTime += 60000;
                updateTimerUI(timer);
            }
        }

        function getEndTimeString(ts) {
            const d = new Date(ts);
            const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (appState.settings.showDate) {
                return d.toLocaleString(undefined, { year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
            }
            return timeStr;
        }

        function updateTimerUI(timer) {
            const elProgress = document.getElementById(`progress-${timer.id}`);
            const elText = document.getElementById(`time-text-${timer.id}`);
            const elEnd = document.getElementById(`end-time-${timer.id}`);
            const elCard = document.getElementById(`timer-card-${timer.id}`);
            const elIcon = document.getElementById(`control-icon-${timer.id}`);

            if (!elProgress) return;

            // Calc Time
            let totalSec = Math.ceil(timer.remainingMs / 1000);
            if (totalSec < 0) totalSec = 0;
            let h = Math.floor(totalSec / 3600);
            let m = Math.floor((totalSec % 3600) / 60);
            let s = totalSec % 60;
            
            let str = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if (h > 0) str = `${h}:${str}`;
            elText.textContent = str;

            // Circle (2*PI*90 = 565)
            const pct = Math.max(0, timer.remainingMs / timer.totalMs);
            elProgress.style.strokeDashoffset = 565 - (565 * pct);

            // Labels & Finished State
            if (timer.finished) {
                elCard.classList.add('finished');
                elEnd.textContent = "終了";
                if(elIcon) elIcon.className = 'bi bi-stop-fill';
            } else {
                elCard.classList.remove('finished');
                if (timer.running) elEnd.textContent = getEndTimeString(timer.endTime);
                else elEnd.textContent = "一時停止中";
            }
        }

        function globalTimerLoop() {
            const now = Date.now();
            let hasActive = false;

            appState.timers.forEach(timer => {
                if (!timer.finished) {
                    hasActive = true;
                    if (timer.running) {
                        const left = timer.endTime - now;
                        if (left <= 0) {
                            // Finished!
                            timer.remainingMs = 0;
                            timer.finished = true;
                            timer.running = false;
                            
                            // Start Alarm
                            playAlarm(); // Play once immediately
                            timer.alarmInterval = setInterval(playAlarm, 1500); // Repeat every 1.5s
                        } else {
                            timer.remainingMs = left;
                        }
                    }
                    updateTimerUI(timer);
                }
            });

            if (appState.timers.length > 0) {
                requestAnimationFrame(globalTimerLoop);
            }
        }

        // === SETTINGS ===
        const modal = document.getElementById('settings-modal');
        const chkSound = document.getElementById('setting-sound');
        const chkDate = document.getElementById('setting-date');

        function openSettings() {
            modal.classList.add('open');
            chkSound.checked = appState.settings.sound;
            chkDate.checked = appState.settings.showDate;
        }
        function closeSettings(e) {
            if (e.target === modal) { saveSettings(); modal.classList.remove('open'); }
        }
        function closeSettingsForce() {
            saveSettings(); modal.classList.remove('open');
        }
        function saveSettings() {
            appState.settings.sound = chkSound.checked;
            appState.settings.showDate = chkDate.checked;
            // Update UI for all timers to reflect date format change
            appState.timers.forEach(t => updateTimerUI(t));
        }

    </script>
</body>
</html>
